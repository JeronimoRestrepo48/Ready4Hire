@inherits LayoutComponentBase
@using Ready4Hire.Data
@using Ready4Hire.MVVM.ViewModels
@using Ready4Hire.MVVM.Models
@using Microsoft.EntityFrameworkCore
@implements IDisposable
@inject IDbContextFactory<AppDbContext> DbFactory
@inject Ready4Hire.Services.AuthService AuthService
@inject NavigationManager Navigation

<!-- Professional CSS -->
<link href="~/css/main-professional.css" rel="stylesheet" />

<!-- Enhanced Frontend Improvements -->
<Components.Layout.EnhancedScripts />

<div class="app-container @GetPageClass()">
    <!-- Professional Sidebar -->
    <div class="sidebar-container">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="brand-icon">R4H</div>
                <div class="brand-text">Ready4Hire</div>
            </div>
            
            <button class="new-chat-button" @onclick="StartNewChat">
                <svg class="new-chat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Nueva Conversación
            </button>
        </div>
        
        <!-- Sidebar Navigation -->
        <div class="sidebar-nav">
            <!-- Main Section -->
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <NavLink href="/home" class="nav-item" Match="NavLinkMatch.All">
                    <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
                        <polyline stroke-linecap="round" stroke-linejoin="round" points="9,22 9,12 15,12 15,22"></polyline>
                    </svg>
                    <span class="nav-item-text">Inicio</span>
                </NavLink>
                
                <NavLink href="/chat/0" class="nav-item" Match="NavLinkMatch.Prefix">
                    <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <span class="nav-item-text">Entrevista</span>
                </NavLink>
            </div>
            
            <!-- Tools Section -->
            <div class="nav-section">
                <div class="nav-section-title">Herramientas</div>
                <NavLink href="/gamification" class="nav-item" Match="NavLinkMatch.All">
                    <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                    </svg>
                    <span class="nav-item-text">Gamificación</span>
                </NavLink>
                
                <NavLink href="/reports" class="nav-item" Match="NavLinkMatch.All">
                    <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="nav-item-text">Reportes</span>
                </NavLink>
                
                <NavLink href="/certificates" class="nav-item" Match="NavLinkMatch.All">
                    <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                    </svg>
                    <span class="nav-item-text">Certificados</span>
                </NavLink>
            </div>
            
            <!-- Personal Section -->
            <div class="nav-section">
                <div class="nav-section-title">Personal</div>
                <NavLink href="/profile" class="nav-item" Match="NavLinkMatch.All">
                    <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="nav-item-text">Mi Perfil</span>
                </NavLink>
                
                <NavLink href="/settings" class="nav-item" Match="NavLinkMatch.All">
                    <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="nav-item-text">Configuración</span>
                </NavLink>
            </div>
            
            @if (chats != null && chats.Any())
            {
                <div class="nav-section">
                    <div class="nav-section-title">Conversaciones Recientes</div>
                    @foreach (var chat in chats.OrderByDescending(c => c.CreatedAt).Take(5))
                    {
                        <NavLink href="@($"/chat/{chat.Id}")" class="nav-item">
                            <svg class="nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <span class="nav-item-text">@(string.IsNullOrEmpty(chat.Title) ? "Nueva Conversación" : chat.Title)</span>
                        </NavLink>
                    }
                </div>
            }
        </div>
        
        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <div class="user-profile-section" @onclick="NavigateToProfile">
                <div class="user-avatar">@GetUserInitials()</div>
                <div class="user-info">
                    <div class="user-name">@GetUserName()</div>
                    <div class="user-email">@GetUserEmail()</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content-container">
        @ChildContent
    </div>
</div>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    
    private List<Chat>? chats;
    private User? currentUser;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            var authenticatedUser = await AuthService.GetCurrentUserAsync();
            
            if (authenticatedUser != null)
            {
                currentUser = await db.Users.FirstOrDefaultAsync(u => u.Email == authenticatedUser.Email);
                
                if (currentUser != null)
                {
                    chats = await db.Chats
                        .Where(c => c.UserId == currentUser.Id)
                        .OrderByDescending(c => c.CreatedAt)
                        .Take(10)
                        .ToListAsync();
                }
            }
            
            // Suscribirse a cambios de navegación
            Navigation.LocationChanged += OnLocationChanged;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading sidebar data: {ex.Message}");
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Forzar actualización cuando cambia la ubicación
        _ = InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private string GetPageClass()
    {
        try
        {
            var uri = Navigation.Uri;
            var path = Navigation.ToBaseRelativePath(uri);
            
            // Debug: imprimir en consola (se puede remover después)
            // Console.WriteLine($"Current path: {path}");
            
            // Normalizar la ruta
            if (string.IsNullOrEmpty(path) || path == "/")
                return "page-home";
            
            if (path.StartsWith("/home", StringComparison.OrdinalIgnoreCase))
                return "page-home";
            
            if (path.StartsWith("/chat", StringComparison.OrdinalIgnoreCase))
                return "page-chat";
            
            if (path.StartsWith("/gamification", StringComparison.OrdinalIgnoreCase))
                return "page-gamification";
            
            if (path.StartsWith("/reports", StringComparison.OrdinalIgnoreCase))
                return "page-reports";
            
            if (path.StartsWith("/certificates", StringComparison.OrdinalIgnoreCase))
                return "page-certificates";
            
            if (path.StartsWith("/profile", StringComparison.OrdinalIgnoreCase))
                return "page-profile";
            
            if (path.StartsWith("/settings", StringComparison.OrdinalIgnoreCase))
                return "page-settings";
            
            // Por defecto, usar el color de home
            return "page-home";
        }
        catch
        {
            return "page-home";
        }
    }

    private void StartNewChat()
    {
        Navigation.NavigateTo("/home", false);
    }

    private void NavigateToProfile()
    {
        Navigation.NavigateTo("/profile", false);
    }

    private string GetUserInitials()
    {
        if (currentUser == null)
            return "U";
        
        var firstName = currentUser.Name?.Trim() ?? "";
        var lastName = currentUser.LastName?.Trim() ?? "";
        
        var initials = "";
        if (!string.IsNullOrEmpty(firstName))
            initials += firstName[0];
        if (!string.IsNullOrEmpty(lastName))
            initials += lastName[0];
        
        return string.IsNullOrEmpty(initials) ? "U" : initials.ToUpper();
    }

    private string GetUserName()
    {
        if (currentUser == null)
            return "Usuario";
        
        var fullName = $"{currentUser.Name} {currentUser.LastName}".Trim();
        return string.IsNullOrEmpty(fullName) ? "Usuario" : fullName;
    }

    private string GetUserEmail()
    {
        return currentUser?.Email ?? "usuario@ejemplo.com";
    }
}
