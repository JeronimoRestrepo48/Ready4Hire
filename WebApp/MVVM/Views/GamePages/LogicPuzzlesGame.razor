@page "/game/logic-puzzles"
@using Microsoft.AspNetCore.Components
@using Ready4Hire.Services
@inject AuthService AuthService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>üß© Rompecabezas L√≥gicos - Ready4Hire</PageTitle>

<div class="game-container">
    <div class="game-header">
        <button class="btn-back" @onclick="GoBack">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Volver
        </button>
        <div class="game-stats-bar">
            <span class="stat-item">üß© Puzzle @currentPuzzle/@totalPuzzles</span>
            <span class="stat-item">üèÜ @currentScore pts</span>
            <span class="stat-item">‚è∞ @FormatTime(timeElapsed)</span>
        </div>
    </div>

    @if (!gameStarted)
    {
        <div class="game-intro">
            <div class="intro-icon">üß©</div>
            <h1>Rompecabezas L√≥gicos</h1>
            <p>Desaf√≠a tu mente con acertijos de l√≥gica y razonamiento</p>
            <div class="game-rules">
                <h3>üéØ Tipos de puzzles:</h3>
                <ul>
                    <li>üî¢ <strong>Secuencias:</strong> Encuentra el siguiente n√∫mero en la serie</li>
                    <li>üé® <strong>Patrones:</strong> Identifica el patr√≥n visual</li>
                    <li>üîç <strong>Deducci√≥n:</strong> Resuelve enigmas l√≥gicos</li>
                    <li>üé≤ <strong>Sudoku Mini:</strong> Completa la cuadr√≠cula</li>
                    <li>‚öñÔ∏è <strong>Balanzas:</strong> Encuentra el peso correcto</li>
                </ul>
            </div>
            <button class="btn-start-game" @onclick="StartGame">
                Comenzar Puzzles
            </button>
        </div>
    }
    else if (gameFinished)
    {
        <div class="game-results">
            <div class="results-icon">@GetPerformanceIcon()</div>
            <h1>¬°Puzzles Completados!</h1>
            <div class="results-stats">
                <div class="result-stat">
                    <div class="stat-value">@currentScore</div>
                    <div class="stat-label">Puntos Totales</div>
                </div>
                <div class="result-stat">
                    <div class="stat-value">@correctAnswers/@totalPuzzles</div>
                    <div class="stat-label">Correctos</div>
                </div>
                <div class="result-stat">
                    <div class="stat-value">@FormatTime(timeElapsed)</div>
                    <div class="stat-label">Tiempo Total</div>
                </div>
            </div>
            <div class="performance-message">
                <p>@GetSuccessMessage()</p>
                <p><strong>An√°lisis:</strong> @GetLogicAnalysis()</p>
            </div>
            <button class="btn-play-again" @onclick="RestartGame">Jugar de Nuevo</button>
            <button class="btn-back-results" @onclick="GoToGamification">Ver Gamificaci√≥n</button>
        </div>
    }
    else
    {
        <div class="game-play">
            <div class="puzzle-container">
                @if (currentPuzzleData != null)
                {
                    <h2>@currentPuzzleData.Question</h2>
                    <div class="puzzle-options">
                        @for (int i = 0; i < currentPuzzleData.Options.Count; i++)
                        {
                            var index = i;
                            var option = currentPuzzleData.Options[index];
                            var cssClass = "puzzle-option";
                            if (selectedAnswer == index)
                            {
                                cssClass += " selected";
                            }
                            
                            <button class="@cssClass" 
                                    @onclick="() => SelectAnswer(index)">
                                @option
                            </button>
                        }
                    </div>
                    <button class="btn-submit" @onclick="SubmitAnswer" disabled="@(selectedAnswer == -1)">
                        Enviar Respuesta
                    </button>
                }
            </div>
        </div>
    }
</div>

<style>
    .game-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
    }

    .game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: rgba(0, 0, 0, 0.2);
    }

    .btn-back {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-back:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .game-stats-bar {
        display: flex;
        gap: 1rem;
    }

    .stat-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }

    .game-intro, .game-results {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 70vh;
        text-align: center;
        padding: 2rem;
    }

    .intro-icon, .results-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .game-rules {
        background: rgba(0, 0, 0, 0.2);
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1.5rem 0;
        text-align: left;
    }

    .btn-start-game, .btn-play-again, .btn-back-results, .btn-submit {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        border: none;
        color: white;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        margin: 0.5rem;
        transition: all 0.2s;
    }

    .btn-start-game:hover, .btn-play-again:hover, .btn-back-results:hover, .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .puzzle-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        text-align: center;
    }

    .puzzle-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }

    .puzzle-option {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1rem;
    }

    .puzzle-option:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
    }

    .puzzle-option.selected {
        background: rgba(255, 255, 255, 0.3);
        border-color: #fff;
    }

    .results-stats {
        display: flex;
        gap: 2rem;
        margin: 2rem 0;
    }

    .result-stat {
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #ffd700;
    }

    .stat-label {
        font-size: 1rem;
        opacity: 0.8;
        margin-top: 0.5rem;
    }

    .performance-message {
        background: rgba(0, 0, 0, 0.2);
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1.5rem 0;
        max-width: 600px;
    }
</style>

@code {
    private bool gameStarted = false;
    private bool gameFinished = false;
    private int currentPuzzle = 1;
    private int totalPuzzles = 5;
    private int currentScore = 0;
    private int correctAnswers = 0;
    private int timeElapsed = 0;
    private int selectedAnswer = -1;

    private PuzzleData? currentPuzzleData;
    private List<PuzzleData> puzzles = new();
    private System.Threading.Timer? gameTimer;

    public class PuzzleData
    {
        public string Question { get; set; } = "";
        public List<string> Options { get; set; } = new();
        public int CorrectAnswer { get; set; }
        public string Type { get; set; } = "";
    }

    protected override void OnInitialized()
    {
        InitializePuzzles();
    }

    private void InitializePuzzles()
    {
        puzzles = new List<PuzzleData>
        {
            new() { 
                Question = "¬øCu√°l es el siguiente n√∫mero en la secuencia: 2, 4, 8, 16, ?", 
                Options = new() {"24", "32", "28", "20"}, 
                CorrectAnswer = 1, 
                Type = "sequence" 
            },
            new() { 
                Question = "Si todos los gatos son animales y algunos animales son salvajes, ¬øqu√© podemos concluir?", 
                Options = new() {"Todos los gatos son salvajes", "Algunos gatos pueden ser salvajes", "Ning√∫n gato es salvaje", "No se puede concluir nada"}, 
                CorrectAnswer = 1, 
                Type = "logic" 
            },
            new() { 
                Question = "¬øQu√© n√∫mero falta? 3, 6, 12, 24, ?", 
                Options = new() {"36", "48", "42", "30"}, 
                CorrectAnswer = 1, 
                Type = "sequence" 
            },
            new() { 
                Question = "Si el tren A sale a las 2:00 PM a 60 km/h y el tren B sale a las 3:00 PM a 80 km/h hacia el mismo destino, ¬øcu√°ndo se encuentran?", 
                Options = new() {"4:00 PM", "5:00 PM", "6:00 PM", "7:00 PM"}, 
                CorrectAnswer = 2, 
                Type = "math" 
            },
            new() { 
                Question = "¬øCu√°l es el patr√≥n? A, C, F, J, ?", 
                Options = new() {"M", "N", "O", "P"}, 
                CorrectAnswer = 2, 
                Type = "pattern" 
            }
        };
    }

    private void StartGame()
    {
        gameStarted = true;
        gameFinished = false;
        currentPuzzle = 1;
        currentScore = 0;
        correctAnswers = 0;
        timeElapsed = 0;
        selectedAnswer = -1;
        
        LoadCurrentPuzzle();
        StartTimer();
    }

    private void LoadCurrentPuzzle()
    {
        if (currentPuzzle <= puzzles.Count)
        {
            currentPuzzleData = puzzles[currentPuzzle - 1];
            selectedAnswer = -1;
        }
    }

    private void StartTimer()
    {
        gameTimer?.Dispose();
        gameTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                timeElapsed++;
                StateHasChanged();
            });
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private void SelectAnswer(int index)
    {
        selectedAnswer = index;
    }

    private void SubmitAnswer()
    {
        if (selectedAnswer == -1 || currentPuzzleData == null) return;

        if (selectedAnswer == currentPuzzleData.CorrectAnswer)
        {
            correctAnswers++;
            currentScore += 100;
        }

        currentPuzzle++;
        
        if (currentPuzzle > totalPuzzles)
        {
            EndGame();
        }
        else
        {
            LoadCurrentPuzzle();
        }
    }

    private void EndGame()
    {
        gameFinished = true;
        gameTimer?.Dispose();
    }

    private void RestartGame()
    {
        StartGame();
    }

    private async Task GoBack()
    {
        if (await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/gamification");
        }
        else
        {
            Navigation.NavigateTo("/login");
        }
    }

    private void GoToGamification()
    {
        Navigation.NavigateTo("/gamification");
    }

    private string GetPerformanceIcon()
    {
        var accuracy = (float)correctAnswers / totalPuzzles;
        return accuracy switch
        {
            >= 0.8f => "üèÜ",
            >= 0.6f => "ü•à", 
            >= 0.4f => "ü•â",
            _ => "üìà"
        };
    }

    private string GetSuccessMessage()
    {
        var accuracy = (float)correctAnswers / totalPuzzles;
        return accuracy switch
        {
            >= 0.8f => "¬°Excelente trabajo! Tienes una mente muy l√≥gica.",
            >= 0.6f => "¬°Bien hecho! Tus habilidades de razonamiento son s√≥lidas.",
            >= 0.4f => "Buen intento. Sigue practicando para mejorar.",
            _ => "No te desanimes. La l√≥gica se desarrolla con pr√°ctica."
        };
    }

    private string GetLogicAnalysis()
    {
        var accuracy = (float)correctAnswers / totalPuzzles;
        var avgTime = timeElapsed / totalPuzzles;
        
        if (accuracy >= 0.8f && avgTime < 30)
            return "Excelente velocidad y precisi√≥n en el razonamiento l√≥gico.";
        else if (accuracy >= 0.6f)
            return "Buena capacidad de an√°lisis, considera trabajar en la velocidad.";
        else
            return "Enf√≥cate en descomponer los problemas paso a paso.";
    }

    private string FormatTime(int seconds)
    {
        var minutes = seconds / 60;
        var remainingSeconds = seconds % 60;
        return $"{minutes:D2}:{remainingSeconds:D2}";
    }

    public void Dispose()
    {
        gameTimer?.Dispose();
    }
}