@page "/game/communication-skills"
@using Microsoft.AspNetCore.Components
@using Ready4Hire.Services
@inject AuthService AuthService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>üí¨ Habilidades de Comunicaci√≥n - Ready4Hire</PageTitle>

<div class="game-container">
    <div class="game-header">
        <button class="btn-back" @onclick="GoBack">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Volver
        </button>
        <div class="game-stats-bar">
            <span class="stat-item">üí¨ Escenario @currentScenario/@totalScenarios</span>
            <span class="stat-item">üèÜ @currentScore pts</span>
            <span class="stat-item">üìä Nivel: @GetCommunicationLevel()</span>
        </div>
    </div>

    @if (!gameStarted)
    {
        <div class="game-intro">
            <div class="intro-icon">üí¨</div>
            <h1>Habilidades de Comunicaci√≥n</h1>
            <p>Practica comunicaci√≥n efectiva en situaciones profesionales reales</p>
            <div class="game-rules">
                <h3>üéØ Competencias evaluadas:</h3>
                <ul>
                    <li>üëÇ <strong>Escucha Activa:</strong> Demostrar comprensi√≥n genuina</li>
                    <li>ü§ù <strong>Empat√≠a:</strong> Conectar emocionalmente</li>
                    <li>üí° <strong>Claridad:</strong> Comunicar ideas de forma precisa</li>
                    <li>üé≠ <strong>Adaptabilidad:</strong> Ajustar el estilo seg√∫n el contexto</li>
                    <li>üîÑ <strong>Retroalimentaci√≥n:</strong> Dar y recibir feedback constructivo</li>
                </ul>

                <h4>üìö Tipos de escenarios:</h4>
                <ul>
                    <li>ü§ù Reuniones de equipo</li>
                    <li>üìû Llamadas con clientes</li>
                    <li>‚ö†Ô∏è Manejo de conflictos</li>
                    <li>üìà Presentaciones</li>
                    <li>üíº Negociaciones</li>
                    <li>üë®‚Äçüíº Evaluaciones de desempe√±o</li>
                </ul>

                <div class="communication-tips">
                    <h4>üí° Principios clave:</h4>
                    <p>‚Ä¢ La comunicaci√≥n es 55% lenguaje corporal, 38% tono, 7% palabras</p>
                    <p>‚Ä¢ Escucha para entender, no para responder</p>
                    <p>‚Ä¢ Adapta tu mensaje a tu audiencia</p>
                    <p>‚Ä¢ La claridad previene malentendidos</p>
                </div>
            </div>
            <div class="difficulty-selector">
                <h4>Selecciona nivel:</h4>
                <div class="difficulty-options">
                    <button class="difficulty-btn @(selectedDifficulty == "junior" ? "selected" : "")" 
                            @onclick='() => SelectDifficulty("junior")'>
                        <span>üü¢ B√°sico</span>
                        <small>3 escenarios, situaciones simples</small>
                    </button>
                    <button class="difficulty-btn @(selectedDifficulty == "mid" ? "selected" : "")" 
                            @onclick='() => SelectDifficulty("mid")'>
                        <span>üü° Intermedio</span>
                        <small>4 escenarios, mayor complejidad</small>
                    </button>
                    <button class="difficulty-btn @(selectedDifficulty == "senior" ? "selected" : "")" 
                            @onclick='() => SelectDifficulty("senior")'>
                        <span>üî¥ Avanzado</span>
                        <small>5 escenarios, situaciones cr√≠ticas</small>
                    </button>
                </div>
            </div>
            <button class="btn-start-game" @onclick="StartGame" disabled="@(selectedDifficulty == null)">
                Comenzar Pr√°ctica
            </button>
        </div>
    }
    else if (gameFinished)
    {
        <div class="game-results">
            <div class="results-icon">@GetPerformanceIcon()</div>
            <h2>¬°Pr√°ctica Completada!</h2>
            <div class="communication-assessment">
                <h3>@GetCommunicationRating()</h3>
                <p>@GetCommunicationDescription()</p>
            </div>
            <div class="results-stats">
                <div class="result-stat highlight">
                    <span class="result-label">Puntuaci√≥n Final</span>
                    <span class="result-value">@currentScore pts</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">Escenarios Completados</span>
                    <span class="result-value">@scenariosCompleted/@totalScenarios</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">Nivel de Comunicaci√≥n</span>
                    <span class="result-value">@GetCommunicationLevel()</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">Efectividad Promedio</span>
                    <span class="result-value">@(Math.Round(averageEffectiveness * 100))%</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">Estilo Dominante</span>
                    <span class="result-value">@GetDominantStyle()</span>
                </div>
                <div class="result-stat">
                    <span class="result-label">√Årea de Mejora</span>
                    <span class="result-value">@GetImprovementArea()</span>
                </div>
            </div>
            <div class="skills-breakdown">
                <h4>üìä Desglose de Habilidades:</h4>
                <div class="skills-chart">
                    <div class="skill-bar">
                        <div class="skill-label">üëÇ Escucha Activa</div>
                        <div class="skill-progress">
                            <div class="skill-fill" style="width: @(listeningScore * 100)%"></div>
                        </div>
                        <div class="skill-score">@(Math.Round(listeningScore * 100))%</div>
                    </div>
                    <div class="skill-bar">
                        <div class="skill-label">ü§ù Empat√≠a</div>
                        <div class="skill-progress">
                            <div class="skill-fill" style="width: @(empathyScore * 100)%"></div>
                        </div>
                        <div class="skill-score">@(Math.Round(empathyScore * 100))%</div>
                    </div>
                    <div class="skill-bar">
                        <div class="skill-label">üí° Claridad</div>
                        <div class="skill-progress">
                            <div class="skill-fill" style="width: @(clarityScore * 100)%"></div>
                        </div>
                        <div class="skill-score">@(Math.Round(clarityScore * 100))%</div>
                    </div>
                    <div class="skill-bar">
                        <div class="skill-label">üé≠ Adaptabilidad</div>
                        <div class="skill-progress">
                            <div class="skill-fill" style="width: @(adaptabilityScore * 100)%"></div>
                        </div>
                        <div class="skill-score">@(Math.Round(adaptabilityScore * 100))%</div>
                    </div>
                </div>
            </div>
            <div class="results-actions">
                <button class="btn-restart" @onclick="RestartGame">
                    Practicar de Nuevo
                </button>
                <button class="btn-gamification" @onclick="GoToGamification">
                    Ver M√°s Juegos
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="game-content">
            <div class="scenario-container">
                <div class="scenario-header">
                    <h2>@currentScenarioData.Title</h2>
                    <div class="scenario-type-badge">@GetScenarioIcon() @currentScenarioData.Type</div>
                </div>

                <div class="scenario-context">
                    <div class="context-card">
                        <h4>üìã Contexto:</h4>
                        <p>@currentScenarioData.Context</p>
                    </div>

                    @if (!string.IsNullOrEmpty(currentScenarioData.SpeakerInfo))
                    {
                        <div class="speaker-card">
                            <h4>üë§ Informaci√≥n del interlocutor:</h4>
                            <p>@currentScenarioData.SpeakerInfo</p>
                        </div>
                    }

                    <div class="situation-card">
                        <h4>üí¨ Situaci√≥n:</h4>
                        <p>@currentScenarioData.Situation</p>
                    </div>
                </div>

                @if (!showingResult)
                {
                    <div class="response-selection">
                        <h3>¬øC√≥mo responder√≠as?</h3>
                        <div class="response-options">
                            @for (int i = 0; i < currentScenarioData.ResponseOptions.Count; i++)
                            {
                                var index = i;
                                var option = currentScenarioData.ResponseOptions[index];
                                <button class="response-btn @(selectedResponse == index ? "selected" : "")"
                                        @onclick="() => SelectResponse(index)"
                                        disabled="@showingResult">
                                    <div class="response-style">@GetResponseStyleIcon(option.Style)</div>
                                    <div class="response-text">@option.Text</div>
                                    <div class="response-approach">@option.Style</div>
                                </button>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="result-feedback">
                        <div class="result-header">
                            <div class="result-icon">
                                @if (currentEffectiveness >= 0.8)
                                {
                                    <span>üåü</span>
                                }
                                else if (currentEffectiveness >= 0.6)
                                {
                                    <span>üëç</span>
                                }
                                else if (currentEffectiveness >= 0.4)
                                {
                                    <span>üëå</span>
                                }
                                else
                                {
                                    <span>üìà</span>
                                }
                            </div>
                            <div class="result-title">
                                <h3>@GetResultTitle()</h3>
                                <div class="effectiveness-score">Efectividad: @(Math.Round(currentEffectiveness * 100))%</div>
                            </div>
                        </div>

                        <div class="response-analysis">
                            <div class="analysis-section">
                                <h4>üí¨ Tu respuesta:</h4>
                                <div class="selected-response">
                                    <span class="response-style-tag">@selectedResponseData.Style</span>
                                    <p>@selectedResponseData.Text</p>
                                </div>
                            </div>

                            <div class="analysis-section">
                                <h4>üìä An√°lisis:</h4>
                                <p>@selectedResponseData.Analysis</p>
                            </div>

                            <div class="analysis-section">
                                <h4>üéØ Impacto:</h4>
                                <p>@selectedResponseData.Impact</p>
                            </div>

                            @if (!string.IsNullOrEmpty(selectedResponseData.BetterAlternative))
                            {
                                <div class="analysis-section improvement">
                                    <h4>üí° Alternativa mejorada:</h4>
                                    <p>@selectedResponseData.BetterAlternative</p>
                                </div>
                            }
                        </div>

                        <div class="skills-impact">
                            <h4>üìà Impacto en habilidades:</h4>
                            <div class="skills-grid">
                                <div class="skill-impact @GetSkillImpactClass(selectedResponseData.ListeningImpact)">
                                    <span class="skill-icon">üëÇ</span>
                                    <span class="skill-name">Escucha</span>
                                    <span class="skill-change">@GetImpactText(selectedResponseData.ListeningImpact)</span>
                                </div>
                                <div class="skill-impact @GetSkillImpactClass(selectedResponseData.EmpathyImpact)">
                                    <span class="skill-icon">ü§ù</span>
                                    <span class="skill-name">Empat√≠a</span>
                                    <span class="skill-change">@GetImpactText(selectedResponseData.EmpathyImpact)</span>
                                </div>
                                <div class="skill-impact @GetSkillImpactClass(selectedResponseData.ClarityImpact)">
                                    <span class="skill-icon">üí°</span>
                                    <span class="skill-name">Claridad</span>
                                    <span class="skill-change">@GetImpactText(selectedResponseData.ClarityImpact)</span>
                                </div>
                                <div class="skill-impact @GetSkillImpactClass(selectedResponseData.AdaptabilityImpact)">
                                    <span class="skill-icon">üé≠</span>
                                    <span class="skill-name">Adaptaci√≥n</span>
                                    <span class="skill-change">@GetImpactText(selectedResponseData.AdaptabilityImpact)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <div class="scenario-actions">
                    @if (!showingResult)
                    {
                        <button class="btn-submit-response" @onclick="SubmitResponse" disabled="@(selectedResponse == -1)">
                            Confirmar Respuesta
                        </button>
                        <button class="btn-communication-tip" @onclick="ShowCommunicationTip">
                            üí° Consejo de Comunicaci√≥n
                        </button>
                    }
                    else
                    {
                        @if (currentScenario < totalScenarios)
                        {
                            <button class="btn-next-scenario" @onclick="NextScenario">
                                Siguiente Escenario ‚û°Ô∏è
                            </button>
                        }
                        else
                        {
                            <button class="btn-finish" @onclick="FinishGame">
                                Ver Resultados Finales üèÜ
                            </button>
                        }
                    }
                </div>

                @if (!string.IsNullOrEmpty(communicationTip))
                {
                    <div class="communication-tip">
                        <div class="tip-icon">üí°</div>
                        <div class="tip-text">@communicationTip</div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private bool gameStarted = false;
    private bool gameFinished = false;
    private bool showingResult = false;

    private int currentScenario = 1;
    private int totalScenarios = 4;
    private int currentScore = 0;
    private int scenariosCompleted = 0;
    private int selectedResponse = -1;

    private double currentEffectiveness = 0;
    private double averageEffectiveness = 0;
    private double listeningScore = 0;
    private double empathyScore = 0;
    private double clarityScore = 0;
    private double adaptabilityScore = 0;

    private string? selectedDifficulty = null;
    private string communicationTip = "";

    private ScenarioData currentScenarioData = new();
    private ResponseOption selectedResponseData = new();
    private List<double> effectivenessHistory = new();

    public class ScenarioData
    {
        public string Title { get; set; } = "";
        public string Type { get; set; } = "";
        public string Context { get; set; } = "";
        public string SpeakerInfo { get; set; } = "";
        public string Situation { get; set; } = "";
        public List<ResponseOption> ResponseOptions { get; set; } = new();
    }

    public class ResponseOption
    {
        public string Text { get; set; } = "";
        public string Style { get; set; } = "";
        public double Effectiveness { get; set; } = 0;
        public string Analysis { get; set; } = "";
        public string Impact { get; set; } = "";
        public string BetterAlternative { get; set; } = "";
        public int ListeningImpact { get; set; } = 0;  // -2 a +2
        public int EmpathyImpact { get; set; } = 0;
        public int ClarityImpact { get; set; } = 0;
        public int AdaptabilityImpact { get; set; } = 0;
    }

    protected override async Task OnInitializedAsync()
    {
        if (!await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/", true);
        }
    }

    private void SelectDifficulty(string difficulty)
    {
        selectedDifficulty = difficulty;
        totalScenarios = difficulty switch
        {
            "junior" => 3,
            "mid" => 4,
            "senior" => 5,
            _ => 4
        };
        StateHasChanged();
    }

    private void StartGame()
    {
        if (selectedDifficulty == null) return;

        gameStarted = true;
        currentScenario = 1;
        currentScore = 0;
        scenariosCompleted = 0;
        effectivenessHistory.Clear();
        
        // Inicializar puntuaciones de habilidades
        listeningScore = 0.5;
        empathyScore = 0.5;
        clarityScore = 0.5;
        adaptabilityScore = 0.5;

        GenerateScenario();
        StateHasChanged();
    }

    private void GenerateScenario()
    {
        selectedResponse = -1;
        showingResult = false;
        communicationTip = "";

        var scenarios = GetScenariosByDifficulty(selectedDifficulty ?? "mid");
        var selectedScenario = scenarios[new Random().Next(scenarios.Length)];
        
        currentScenarioData = selectedScenario;
    }

    private ScenarioData[] GetScenariosByDifficulty(string difficulty)
    {
        var basicScenarios = new[]
        {
            new ScenarioData
            {
                Title = "Reuni√≥n de Equipo Semanal",
                Type = "Reuni√≥n de equipo",
                Context = "Es lunes por la ma√±ana y tienes la reuni√≥n semanal de tu equipo de trabajo.",
                SpeakerInfo = "Tu colega Mar√≠a parece estresada y ha llegado tarde a la reuni√≥n.",
                Situation = "Mar√≠a dice: 'Disculpen la tardanza, pero tengo demasiado trabajo y no s√© c√≥mo voy a cumplir con los deadlines de esta semana.'",
                ResponseOptions = new List<ResponseOption>
                {
                    new ResponseOption
                    {
                        Text = "No te preocupes Mar√≠a, todos tenemos d√≠as dif√≠ciles. ¬øEn qu√© podemos ayudarte?",
                        Style = "Emp√°tico y colaborativo",
                        Effectiveness = 0.9,
                        Analysis = "Demuestras empat√≠a y ofreces apoyo concreto, creando un ambiente de colaboraci√≥n.",
                        Impact = "Mar√≠a se siente comprendida y el equipo se une para buscar soluciones.",
                        ListeningImpact = 2,
                        EmpathyImpact = 2,
                        ClarityImpact = 1,
                        AdaptabilityImpact = 1
                    },
                    new ResponseOption
                    {
                        Text = "Mar√≠a, necesitas organizarte mejor. Todos tenemos mucho trabajo.",
                        Style = "Directo y cr√≠tico",
                        Effectiveness = 0.3,
                        Analysis = "Tu respuesta minimiza sus sentimientos y no ofrece ayuda constructiva.",
                        Impact = "Mar√≠a se siente juzgada y menos inclinada a pedir ayuda en el futuro.",
                        BetterAlternative = "Reconoce su situaci√≥n y ofrece apoyo: '¬øQu√© tareas son m√°s urgentes? Veamos c√≥mo redistribuir la carga.'",
                        ListeningImpact = -1,
                        EmpathyImpact = -2,
                        ClarityImpact = 1,
                        AdaptabilityImpact = -1
                    },
                    new ResponseOption
                    {
                        Text = "¬øPodr√≠as especificar exactamente qu√© tareas te est√°n causando problemas?",
                        Style = "Anal√≠tico y estructurado",
                        Effectiveness = 0.7,
                        Analysis = "Buscas informaci√≥n espec√≠fica para entender mejor el problema, lo cual es √∫til.",
                        Impact = "Ayudas a Mar√≠a a clarificar sus desaf√≠os, aunque podr√≠as ser m√°s emp√°tico inicialmente.",
                        ListeningImpact = 1,
                        EmpathyImpact = 0,
                        ClarityImpact = 2,
                        AdaptabilityImpact = 1
                    },
                    new ResponseOption
                    {
                        Text = "Entiendo tu situaci√≥n. ¬øQu√© tal si revisamos juntos tus prioridades despu√©s de la reuni√≥n?",
                        Style = "Comprensivo y proactivo",
                        Effectiveness = 0.85,
                        Analysis = "Combinas empat√≠a con una acci√≥n concreta, ofreciendo ayuda sin interrumpir la reuni√≥n.",
                        Impact = "Mar√≠a se siente apoyada y tienes un plan claro para ayudarla.",
                        ListeningImpact = 2,
                        EmpathyImpact = 1,
                        ClarityImpact = 2,
                        AdaptabilityImpact = 2
                    }
                }
            }
        };

        var intermediateScenarios = new[]
        {
            new ScenarioData
            {
                Title = "Cliente Insatisfecho",
                Type = "Atenci√≥n al cliente",
                Context = "Eres responsable de atenci√≥n al cliente y recibes una llamada de un cliente muy molesto.",
                SpeakerInfo = "El cliente Juan est√° frustrado porque el producto que compr√≥ no funciona como esperaba.",
                Situation = "Juan dice: 'Este producto es una basura! He perdido tres horas tratando de hacerlo funcionar. Quiero mi dinero de vuelta AHORA!'",
                ResponseOptions = new List<ResponseOption>
                {
                    new ResponseOption
                    {
                        Text = "Entiendo completamente su frustraci√≥n, Juan. Nadie deber√≠a pasar por eso. Vamos a solucionarlo juntos.",
                        Style = "Emp√°tico y solucionador",
                        Effectiveness = 0.9,
                        Analysis = "Validas sus emociones y te posicionas como su aliado para resolver el problema.",
                        Impact = "Juan se calma y se muestra m√°s receptivo a trabajar contigo en una soluci√≥n.",
                        ListeningImpact = 2,
                        EmpathyImpact = 2,
                        ClarityImpact = 1,
                        AdaptabilityImpact = 2
                    },
                    new ResponseOption
                    {
                        Text = "Se√±or, le pido que mantenga la calma. Gritarme no va a resolver su problema.",
                        Style = "Defensivo",
                        Effectiveness = 0.2,
                        Analysis = "Te enfocas en su tono en lugar del problema, lo que puede escalarlo m√°s.",
                        Impact = "Juan se siente atacado y la situaci√≥n se vuelve m√°s tensa.",
                        BetterAlternative = "Reconoce su frustraci√≥n primero: 'Veo que est√° muy frustrado, y es comprensible. D√©jeme ayudarle.'",
                        ListeningImpact = -1,
                        EmpathyImpact = -2,
                        ClarityImpact = 0,
                        AdaptabilityImpact = -1
                    },
                    new ResponseOption
                    {
                        Text = "Lamento que est√© teniendo problemas. Seg√∫n nuestra pol√≠tica, necesito algunos datos para procesar el reembolso.",
                        Style = "Procedural",
                        Effectiveness = 0.6,
                        Analysis = "Te enfocas en el proceso pero no abordas sus emociones, lo cual puede frustrarlo m√°s.",
                        Impact = "Juan podr√≠a percibir que no te importa su situaci√≥n, solo seguir reglas.",
                        ListeningImpact = 0,
                        EmpathyImpact = -1,
                        ClarityImpact = 2,
                        AdaptabilityImpact = 0
                    },
                    new ResponseOption
                    {
                        Text = "Juan, puedo escuchar lo frustrado que est√°. Primero, d√©jeme disculparme por esta experiencia. ¬øPodr√≠a contarme exactamente qu√© pas√≥?",
                        Style = "Emp√°tico y investigativo",
                        Effectiveness = 0.85,
                        Analysis = "Reconoces sus emociones, te disculpas y buscas entender el problema espec√≠fico.",
                        Impact = "Juan se siente escuchado y valorado, m√°s dispuesto a explicar los detalles.",
                        ListeningImpact = 2,
                        EmpathyImpact = 1,
                        ClarityImpact = 1,
                        AdaptabilityImpact = 1
                    }
                }
            }
        };

        return difficulty switch
        {
            "junior" => basicScenarios,
            "mid" => intermediateScenarios,
            "senior" => intermediateScenarios, // Podr√≠as agregar m√°s escenarios avanzados
            _ => basicScenarios
        };
    }

    private void SelectResponse(int index)
    {
        selectedResponse = index;
        StateHasChanged();
    }

    private void SubmitResponse()
    {
        if (selectedResponse == -1) return;

        selectedResponseData = currentScenarioData.ResponseOptions[selectedResponse];
        currentEffectiveness = selectedResponseData.Effectiveness;
        effectivenessHistory.Add(currentEffectiveness);

        // Actualizar puntuaciones de habilidades
        listeningScore = Math.Max(0, Math.Min(1, listeningScore + selectedResponseData.ListeningImpact * 0.1));
        empathyScore = Math.Max(0, Math.Min(1, empathyScore + selectedResponseData.EmpathyImpact * 0.1));
        clarityScore = Math.Max(0, Math.Min(1, clarityScore + selectedResponseData.ClarityImpact * 0.1));
        adaptabilityScore = Math.Max(0, Math.Min(1, adaptabilityScore + selectedResponseData.AdaptabilityImpact * 0.1));

        // Calcular puntos
        var basePoints = (int)(currentEffectiveness * 200);
        currentScore += basePoints;

        if (currentEffectiveness >= 0.8)
        {
            scenariosCompleted++;
        }

        showingResult = true;
        StateHasChanged();
    }

    private void ShowCommunicationTip()
    {
        var tips = new[]
        {
            "Usa el reflejo activo: 'Si entiendo bien, te sientes...'",
            "El lenguaje corporal comunica m√°s que las palabras",
            "Haz preguntas abiertas para fomentar el di√°logo",
            "Parafrasea lo que escuchas para confirmar comprensi√≥n",
            "Adapta tu estilo comunicativo a la personalidad del otro",
            "El silencio tambi√©n es comunicaci√≥n - √∫salo estrat√©gicamente",
            "Separa el problema de la persona en conversaciones dif√≠ciles",
            "Usa 'yo' en lugar de 't√∫' para evitar defensividad"
        };

        communicationTip = tips[new Random().Next(tips.Length)];
        StateHasChanged();

        // Limpiar tip despu√©s de 8 segundos
        Task.Delay(8000).ContinueWith(_ => InvokeAsync(() =>
        {
            communicationTip = "";
            StateHasChanged();
        }));
    }

    private void NextScenario()
    {
        currentScenario++;
        GenerateScenario();
        StateHasChanged();
    }

    private void FinishGame()
    {
        gameFinished = true;
        averageEffectiveness = effectivenessHistory.Any() ? effectivenessHistory.Average() : 0;
        StateHasChanged();
    }

    private void RestartGame()
    {
        gameFinished = false;
        gameStarted = false;
        selectedDifficulty = null;
        StateHasChanged();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/gamification", false);
    }

    private void GoToGamification()
    {
        Navigation.NavigateTo("/gamification", false);
    }

    private string GetScenarioIcon()
    {
        return currentScenarioData.Type switch
        {
            "Reuni√≥n de equipo" => "üë•",
            "Atenci√≥n al cliente" => "üìû",
            "Resoluci√≥n de conflictos" => "‚öñÔ∏è",
            "Presentaci√≥n" => "üìä",
            "Negociaci√≥n" => "ü§ù",
            "Evaluaci√≥n" => "üìã",
            _ => "üí¨"
        };
    }

    private string GetResponseStyleIcon(string style)
    {
        return style.ToLower() switch
        {
            string s when s.Contains("emp√°tico") => "ü§ó",
            string s when s.Contains("directo") => "‚ö°",
            string s when s.Contains("anal√≠tico") => "üß†",
            string s when s.Contains("colaborativo") => "ü§ù",
            string s when s.Contains("comprensivo") => "üíù",
            string s when s.Contains("defensivo") => "üõ°Ô∏è",
            string s when s.Contains("procedural") => "üìã",
            string s when s.Contains("investigativo") => "üîç",
            _ => "üí¨"
        };
    }

    private string GetResultTitle()
    {
        return currentEffectiveness switch
        {
            >= 0.9 => "¬°Comunicaci√≥n Excepcional!",
            >= 0.8 => "¬°Muy Buena Comunicaci√≥n!",
            >= 0.6 => "Comunicaci√≥n Efectiva",
            >= 0.4 => "Comunicaci√≥n Aceptable",
            _ => "Oportunidad de Mejora"
        };
    }

    private string GetSkillImpactClass(int impact)
    {
        return impact switch
        {
            >= 2 => "positive-high",
            1 => "positive-low",
            0 => "neutral",
            -1 => "negative-low",
            _ => "negative-high"
        };
    }

    private string GetImpactText(int impact)
    {
        return impact switch
        {
            2 => "++",
            1 => "+",
            0 => "=",
            -1 => "-",
            _ => "--"
        };
    }

    private string GetPerformanceIcon()
    {
        return averageEffectiveness switch
        {
            >= 0.8 => "üåü",
            >= 0.6 => "üëç",
            >= 0.4 => "üìà",
            _ => "üí™"
        };
    }

    private string GetCommunicationRating()
    {
        return averageEffectiveness switch
        {
            >= 0.8 => "Comunicador Excepcional",
            >= 0.6 => "Buen Comunicador",
            >= 0.4 => "Comunicador en Desarrollo",
            _ => "Necesita Pr√°ctica"
        };
    }

    private string GetCommunicationDescription()
    {
        return averageEffectiveness switch
        {
            >= 0.8 => "Demuestras habilidades de comunicaci√≥n excepcionales. Sabes c√≥mo conectar con otros y manejar situaciones complejas.",
            >= 0.6 => "Tienes buenas bases de comunicaci√≥n. Con pr√°ctica adicional puedes alcanzar un nivel excepcional.",
            >= 0.4 => "Est√°s desarrollando tus habilidades comunicativas. Enf√≥cate en la escucha activa y la empat√≠a.",
            _ => "La comunicaci√≥n efectiva se desarrolla con pr√°ctica. Considera t√©cnicas de escucha activa y manejo emocional."
        };
    }

    private string GetCommunicationLevel()
    {
        var avgScore = (listeningScore + empathyScore + clarityScore + adaptabilityScore) / 4;
        return avgScore switch
        {
            >= 0.8 => "Avanzado",
            >= 0.6 => "Intermedio",
            >= 0.4 => "B√°sico",
            _ => "Inicial"
        };
    }

    private string GetDominantStyle()
    {
        if (empathyScore > 0.7) return "Emp√°tico";
        if (clarityScore > 0.7) return "Directo";
        if (listeningScore > 0.7) return "Anal√≠tico";
        if (adaptabilityScore > 0.7) return "Adaptativo";
        return "Equilibrado";
    }

    private string GetImprovementArea()
    {
        var scores = new Dictionary<string, double>
        {
            { "Escucha Activa", listeningScore },
            { "Empat√≠a", empathyScore },
            { "Claridad", clarityScore },
            { "Adaptabilidad", adaptabilityScore }
        };

        return scores.OrderBy(x => x.Value).First().Key;
    }
}

<style>
    .game-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #ffffff;
        font-family: 'Segoe UI', system-ui, sans-serif;
    }

    .game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        flex-wrap: wrap;
        gap: 1rem;
    }

    .btn-back {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ffffff;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-back:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
    }

    .game-stats-bar {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .stat-item {
        font-weight: 500;
        font-size: 0.85rem;
        padding: 0.3rem 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        white-space: nowrap;
    }

    .game-intro {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 80px);
        text-align: center;
        padding: 2rem;
    }

    .intro-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: communication-pulse 2s ease-in-out infinite;
    }

    @@keyframes communication-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .game-intro h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        background: linear-gradient(45deg, #ffffff 0%, #9b59b6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .game-intro p {
        font-size: 1.2rem;
        color: #e8e8e8;
        margin-bottom: 2rem;
    }

    .game-rules {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        text-align: left;
        max-width: 800px;
    }

    .game-rules h3, .game-rules h4 {
        color: #9b59b6;
        margin-bottom: 0.8rem;
    }

    .game-rules ul {
        list-style: none;
        padding: 0;
        margin-bottom: 1rem;
    }

    .game-rules li {
        margin-bottom: 0.4rem;
        font-size: 0.95rem;
    }

    .communication-tips {
        background: rgba(155, 89, 182, 0.1);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid rgba(155, 89, 182, 0.3);
        margin-top: 1rem;
    }

    .communication-tips h4 {
        color: #9b59b6;
        margin-bottom: 0.5rem;
    }

    .communication-tips p {
        margin: 0.2rem 0;
        font-size: 0.9rem;
        color: #e8e8e8;
    }

    .difficulty-selector {
        margin-bottom: 2rem;
    }

    .difficulty-selector h4 {
        color: #9b59b6;
        margin-bottom: 1rem;
    }

    .difficulty-options {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .difficulty-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        color: white;
        min-width: 160px;
    }

    .difficulty-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(155, 89, 182, 0.5);
    }

    .difficulty-btn.selected {
        background: rgba(155, 89, 182, 0.2);
        border-color: #9b59b6;
    }

    .difficulty-btn span {
        font-weight: 600;
        margin-bottom: 0.3rem;
    }

    .difficulty-btn small {
        color: #b0b0b0;
        font-size: 0.8rem;
        text-align: center;
    }

    .btn-start-game {
        background: linear-gradient(45deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
    }

    .btn-start-game:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-start-game:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4);
    }

    .game-content {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        min-height: calc(100vh - 140px);
    }

    .scenario-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .scenario-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .scenario-header h2 {
        color: #9b59b6;
        margin: 0;
    }

    .scenario-type-badge {
        background: rgba(155, 89, 182, 0.2);
        color: #9b59b6;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .scenario-context {
        display: grid;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .context-card, .speaker-card, .situation-card {
        background: rgba(255, 255, 255, 0.03);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .context-card h4, .speaker-card h4, .situation-card h4 {
        color: #9b59b6;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .context-card p, .speaker-card p, .situation-card p {
        color: #e8e8e8;
        line-height: 1.6;
        margin: 0;
    }

    .response-selection {
        margin-bottom: 2rem;
    }

    .response-selection h3 {
        color: #9b59b6;
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .response-options {
        display: grid;
        gap: 1rem;
    }

    .response-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        color: white;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 1rem;
        align-items: center;
    }

    .response-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(155, 89, 182, 0.5);
        transform: translateY(-1px);
    }

    .response-btn.selected {
        background: rgba(155, 89, 182, 0.2);
        border-color: #9b59b6;
    }

    .response-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .response-style {
        font-size: 1.5rem;
    }

    .response-text {
        font-size: 1rem;
        line-height: 1.4;
    }

    .response-approach {
        font-size: 0.8rem;
        color: #9b59b6;
        font-weight: 600;
        text-align: right;
    }

    .result-feedback {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .result-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .result-icon {
        font-size: 2.5rem;
    }

    .result-title h3 {
        color: #9b59b6;
        margin: 0 0 0.5rem 0;
    }

    .effectiveness-score {
        color: #e8e8e8;
        font-size: 0.9rem;
    }

    .response-analysis {
        display: grid;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .analysis-section h4 {
        color: #9b59b6;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .analysis-section p {
        color: #e8e8e8;
        line-height: 1.6;
        margin: 0;
    }

    .analysis-section.improvement {
        background: rgba(46, 204, 113, 0.1);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid rgba(46, 204, 113, 0.3);
    }

    .selected-response {
        background: rgba(155, 89, 182, 0.1);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid rgba(155, 89, 182, 0.3);
    }

    .response-style-tag {
        background: rgba(155, 89, 182, 0.3);
        color: #9b59b6;
        padding: 0.2rem 0.8rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 0.5rem;
    }

    .skills-impact {
        margin-bottom: 2rem;
    }

    .skills-impact h4 {
        color: #9b59b6;
        margin-bottom: 1rem;
    }

    .skills-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
    }

    .skill-impact {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 1rem;
        border-radius: 8px;
        border: 2px solid transparent;
    }

    .skill-impact.positive-high {
        background: rgba(46, 204, 113, 0.2);
        border-color: #2ecc71;
    }

    .skill-impact.positive-low {
        background: rgba(46, 204, 113, 0.1);
        border-color: rgba(46, 204, 113, 0.5);
    }

    .skill-impact.neutral {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .skill-impact.negative-low {
        background: rgba(231, 76, 60, 0.1);
        border-color: rgba(231, 76, 60, 0.5);
    }

    .skill-impact.negative-high {
        background: rgba(231, 76, 60, 0.2);
        border-color: #e74c3c;
    }

    .skill-icon {
        font-size: 1.2rem;
    }

    .skill-name {
        flex: 1;
        font-weight: 500;
    }

    .skill-change {
        font-weight: 700;
        font-size: 1.1rem;
    }

    .scenario-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin: 2rem 0;
    }

    .btn-submit-response, .btn-communication-tip, .btn-next-scenario, .btn-finish {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 1rem;
    }

    .btn-submit-response {
        background: linear-gradient(45deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
    }

    .btn-communication-tip {
        background: rgba(243, 156, 18, 0.2);
        color: #f39c12;
        border: 1px solid rgba(243, 156, 18, 0.3);
    }

    .btn-next-scenario {
        background: linear-gradient(45deg, #2ecc71 0%, #27ae60 100%);
        color: white;
    }

    .btn-finish {
        background: linear-gradient(45deg, #e67e22 0%, #d35400 100%);
        color: white;
    }

    .btn-submit-response:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-submit-response:hover:not(:disabled), .btn-next-scenario:hover, .btn-finish:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .communication-tip {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: rgba(243, 156, 18, 0.1);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid rgba(243, 156, 18, 0.3);
        margin-top: 1rem;
    }

    .tip-icon {
        font-size: 1.5rem;
        color: #f39c12;
    }

    .tip-text {
        color: #f39c12;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .game-results {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 80px);
        text-align: center;
        padding: 2rem;
    }

    .results-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .game-results h2 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(45deg, #9b59b6 0%, #8e44ad 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .communication-assessment {
        margin-bottom: 2rem;
        max-width: 600px;
    }

    .communication-assessment h3 {
        color: #9b59b6;
        margin-bottom: 0.5rem;
    }

    .communication-assessment p {
        color: #e8e8e8;
        line-height: 1.6;
    }

    .results-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
        width: 100%;
        max-width: 1000px;
    }

    .result-stat {
        background: rgba(255, 255, 255, 0.05);
        padding: 1.2rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .result-stat.highlight {
        background: rgba(155, 89, 182, 0.1);
        border-color: #9b59b6;
    }

    .result-label {
        display: block;
        color: #b0b0b0;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }

    .result-value {
        display: block;
        font-size: 1.3rem;
        font-weight: 600;
        color: #9b59b6;
    }

    .skills-breakdown {
        margin-bottom: 2rem;
        max-width: 600px;
        width: 100%;
    }

    .skills-breakdown h4 {
        color: #9b59b6;
        margin-bottom: 1rem;
    }

    .skills-chart {
        display: grid;
        gap: 1rem;
    }

    .skill-bar {
        display: grid;
        grid-template-columns: 120px 1fr 60px;
        gap: 1rem;
        align-items: center;
    }

    .skill-label {
        font-size: 0.9rem;
        color: #e8e8e8;
    }

    .skill-progress {
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .skill-fill {
        height: 100%;
        background: linear-gradient(90deg, #9b59b6 0%, #8e44ad 100%);
        transition: width 0.8s ease;
    }

    .skill-score {
        font-size: 0.85rem;
        font-weight: 600;
        color: #9b59b6;
        text-align: right;
    }

    .results-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .btn-restart, .btn-gamification {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 1rem;
    }

    .btn-restart {
        background: linear-gradient(45deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
    }

    .btn-gamification {
        background: transparent;
        color: #e8e8e8;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-restart:hover, .btn-gamification:hover {
        transform: translateY(-1px);
    }

    .btn-gamification:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }
</style>
