@page "/chat"
@using System.Collections.Generic

@inject IJSRuntime JS


<script>
    //Script para scroll automatico
    window.scrollToBottom = () => 
    {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };
</script>

<div class="chat-container">

    <div class="chat-header">
        <span>Habilidades blandas y tecnicas, practico o examen</span>
        
        @if (started && currentPhase != "completed")
        {
            <div class="phase-indicator">
                @if (currentPhase == "context")
                {
                    <span class="phase-badge context-phase">
                        🎯 Fase de Contexto: @contextQuestionsAnswered/5
                    </span>
                }
                else if (currentPhase == "questions")
                {
                    <span class="phase-badge technical-phase">
                        🔬 Fase Técnica: @questionCount/10
                    </span>
                }
                
                @if (isExamMode)
                {
                    <span class="timer-badge">
                        ⏱️ @timerDisplay
                    </span>
                }
            </div>
        }
    </div>

    <div class="chat-body" @ref="chatBodyRef">
        <!-- Lista de mensajes -->
        @foreach (var message in Messages)
        {
            <div class="chat-message @(message.IsUser ? "user-message" : "agent-message")">

                <div class="message-content">
                    @if (!message.IsUser)
                    {
                        <span class="icon-agent"><i class="bi bi-robot"></i></span>
                    }
                    @message.Text
                    @if (message.IsUser)
                    {
                        <img src="images/user-avatar.png" class="avatar" alt="Usuario" />
                    }
                </div>
            </div>
        }
    </div>

    <div class="chat-input-bar">

        @if (!started)
        {
            <button class="chat-tools" @onclick="ShowSetup">⚙️ Configurar</button>
            <button class="chat-start" @onclick="StartInterview" disabled="@(!IsConfigured)">▶️ Comenzar Entrevista</button>
        }
        else if (currentPhase != "completed")
        {
            <textarea class="chat-input"
                  placeholder="Escribe tu respuesta..."
                  @bind="UserInput"
                  @onkeydown="HandleKeyDown"
                  rows="2">
            </textarea>
            <button class="chat-send" @onclick="SendMessage" disabled="@string.IsNullOrWhiteSpace(UserInput)">📤 Enviar</button>
            <button class="chat-end" @onclick="EndInterview">🏁 Finalizar</button>
        }
        else
        {
            <button class="chat-restart" @onclick="RestartInterview">🔄 Nueva Entrevista</button>
        }

        @if (ShowConfig)
        {
            <div class="config-modal">
                <div class="config-content">
                    <h4>Configurar Entrevista</h4>
                    
                    <label>Rol/Posición:</label>
                    <select @bind="SelectedRole">
                        <option value="Backend Developer - .NET">Backend Developer (.NET)</option>
                        <option value="Backend Developer - Java">Backend Developer (Java)</option>
                        <option value="Frontend Developer - React">Frontend Developer (React)</option>
                        <option value="Frontend Developer - Angular">Frontend Developer (Angular)</option>
                        <option value="Full Stack Developer">Full Stack Developer</option>
                        <option value="DevOps Engineer - Azure">DevOps Engineer (Azure)</option>
                        <option value="DevOps Engineer - AWS">DevOps Engineer (AWS)</option>
                        <option value="Data Scientist">Data Scientist</option>
                        <option value="Data Engineer">Data Engineer</option>
                        <option value="QA Engineer - Manual">QA Engineer (Manual)</option>
                        <option value="QA Engineer - Automation">QA Engineer (Automation)</option>
                        <option value="Cybersecurity Analyst">Cybersecurity Analyst</option>
                        <option value="Mobile Developer - Android">Mobile Developer (Android)</option>
                        <option value="Mobile Developer - iOS">Mobile Developer (iOS)</option>
                        <option value="Product Manager">Product Manager</option>
                        <option value="Scrum Master">Scrum Master</option>
                    </select>
                    
                    <label>Tipo de entrevista:</label>
                    <select @bind="SelectedInterviewType">
                        <option value="technical">Técnica</option>
                        <option value="soft_skills">Habilidades Blandas</option>
                    </select>
                    
                    <label>Dificultad:</label>
                    <select @bind="SelectedDifficulty">
                        <option value="junior">Junior</option>
                        <option value="mid">Mid</option>
                        <option value="senior">Senior</option>
                    </select>
                    
                    <label>Modo:</label>
                    <select @bind="SelectedMode">
                        <option value="practice">Práctica</option>
                        <option value="exam">Examen</option>
                    </select>
                    
                    <div style="margin-top:10px;">
                        <button @onclick="SaveConfig">Guardar</button>
                        <button @onclick="HideSetup">Cancelar</button>
                    </div>
                </div>
            </div>
        }
    </div>

</div>