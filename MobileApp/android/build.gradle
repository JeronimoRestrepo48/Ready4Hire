// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
    ext {
        buildToolsVersion = "34.0.0"
        minSdkVersion = 21
        compileSdkVersion = 34
        targetSdkVersion = 34

        // We use NDK 23 which has both M1 support and is the side-by-side NDK version from AGP.
        ndkVersion = "23.1.7779620"
    }
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath("com.android.tools.build:gradle:8.0.2")
        classpath("com.facebook.react:react-native-gradle-plugin")
    }
}

// Configurar Java - usar 17 como target aunque tengamos Java 21
allprojects {
    repositories {
        google()
        mavenCentral()
    }
    
    tasks.withType(JavaCompile) {
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }
    
    // Habilitar BuildConfig para módulos de librería (AGP 8.0+)
    afterEvaluate { project ->
        if (project.plugins.hasPlugin("com.android.library")) {
            project.android.buildFeatures.buildConfig = true
        }
    }
}

// Configuración global para todos los submódulos (AGP 8.0+)
// Esta configuración aplica namespace automáticamente a todos los módulos de librería
subprojects {
    // Función helper para extraer namespace del AndroidManifest
    def extractNamespaceFromManifest = { proj ->
        def manifestFile = proj.file("src/main/AndroidManifest.xml")
        if (!manifestFile.exists()) {
            manifestFile = proj.file("AndroidManifest.xml")
        }
        if (manifestFile.exists()) {
            try {
                def manifestContent = manifestFile.text
                def namespaceMatch = manifestContent =~ /package=["']([^"']+)["']/
                if (namespaceMatch.find()) {
                    return namespaceMatch.group(1)
                }
            } catch (Exception e) {
                // Ignorar errores
            }
        }
        return null
    }
    
    // Paso 1: Extraer namespace ANTES de evaluar
    beforeEvaluate { project ->
        def extractedNamespace = extractNamespaceFromManifest(project)
        if (extractedNamespace != null) {
            project.ext.defaultNamespace = extractedNamespace
        }
    }
    
    // Paso 2: Aplicar namespace ANTES de que se evalúe el bloque android
    // Esto se ejecuta cuando el plugin se aplica pero antes de la evaluación completa
    pluginManager.withPlugin("com.android.library") {
        if (project.ext.has('defaultNamespace')) {
            // Aplicar el script que inyecta namespace en el bloque android
            // Se aplica ANTES de la evaluación para que esté disponible
            def namespaceScript = file("${rootProject.projectDir}/android/apply-namespace.gradle")
            if (namespaceScript.exists()) {
                apply from: namespaceScript
            } else {
                // Fallback directo si el script no existe
                project.android {
                    namespace = project.ext.defaultNamespace
                }
            }
        }
    }
    
    // Paso 3: Asegurar namespace también en afterEvaluate como fallback final
    afterEvaluate { project ->
        if (project.plugins.hasPlugin("com.android.library")) {
            // Verificar si el namespace está establecido, si no, establecerlo
            try {
                def currentNamespace = project.android.hasProperty('namespace') ? project.android.namespace : null
                if ((currentNamespace == null || currentNamespace.isEmpty()) && project.ext.has('defaultNamespace')) {
                    // Último recurso: establecer namespace después de la evaluación
                    // Esto puede no funcionar para AGP 8.0, pero intentamos como fallback
                    project.android.namespace = project.ext.defaultNamespace
                }
            } catch (Exception e) {
                // Namespace ya está configurado o no se puede establecer
            }
            
            def projectPath = project.projectDir.toString()
            if (projectPath.contains("react-native-code-push")) {
                // Para cada variante, crear configuraciones con atributos
                project.android.libraryVariants.all { variant ->
                    def buildTypeName = variant.buildType.name
                    
                    // API Elements
                    def apiElements = project.configurations.findByName("${buildTypeName}ApiElements") 
                        ?: project.configurations.create("${buildTypeName}ApiElements")
                    apiElements.setCanBeResolved(false)
                    apiElements.setCanBeConsumed(true)
                    apiElements.attributes {
                        attribute(com.android.build.api.attributes.BuildTypeAttr, 
                            project.objects.named(com.android.build.api.attributes.BuildType, buildTypeName))
                        attribute(com.android.build.api.attributes.AgpVersionAttr,
                            project.objects.named(com.android.build.api.attributes.AgpVersion, "8.0.2"))
                        attribute(Usage.USAGE_ATTRIBUTE, project.objects.named(Usage, Usage.JAVA_API))
                    }
                    apiElements.outgoing.artifact(variant.packageLibraryProvider)
                    
                    // Runtime Elements  
                    def runtimeElements = project.configurations.findByName("${buildTypeName}RuntimeElements")
                        ?: project.configurations.create("${buildTypeName}RuntimeElements")
                    runtimeElements.setCanBeResolved(false)
                    runtimeElements.setCanBeConsumed(true)
                    runtimeElements.attributes {
                        attribute(com.android.build.api.attributes.BuildTypeAttr,
                            project.objects.named(com.android.build.api.attributes.BuildType, buildTypeName))
                        attribute(com.android.build.api.attributes.AgpVersionAttr,
                            project.objects.named(com.android.build.api.attributes.AgpVersion, "8.0.2"))
                        attribute(Usage.USAGE_ATTRIBUTE, project.objects.named(Usage, Usage.JAVA_RUNTIME))
                    }
                    runtimeElements.outgoing.artifact(variant.packageLibraryProvider)
                }
            }
        }
    }
}
